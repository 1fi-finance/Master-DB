# Sanctions

## Tables

### loan_sanction

Loan sanction master table containing sanction details, EMI calculations, and agreement tracking for approved loan applications.

**Primary Key:** `id` (UUID)

**Foreign Key:** `loanApplicationId` â†’ `loan_applications.id` (ON DELETE RESTRICT, UNIQUE)

**Columns:**
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, NOT NULL | Unique sanction identifier |
| loanApplicationId | UUID | FK, NOT NULL, UNIQUE | Reference to loan application (one-to-one) |
| sanctionLetterNumber | VARCHAR(100) | NOT NULL, UNIQUE | Unique sanction letter identifier |
| sanctionedAmount | DECIMAL(15,2) | NOT NULL | Total loan amount sanctioned |
| sanctionedInterestRate | DECIMAL(8,4) | NOT NULL | Annual interest rate (percentage) |
| sanctionedTenureMonths | INTEGER | NOT NULL | Loan tenure in months |
| sanctionDate | TIMESTAMP | NOT NULL, DEFAULT NOW | Date when sanction was approved |
| validUntil | TIMESTAMP | NOT NULL | Sanction validity expiration date |
| emiType | VARCHAR(20) | NOT NULL | EMI type (e.g., "EMI", "Monthly", "Custom") |
| emiAmount | DECIMAL(15,2) | - | Monthly EMI amount |
| totalInterestPayable | DECIMAL(15,2) | NOT NULL | Total interest payable over tenure |
| totalAmountPayable | DECIMAL(15,2) | NOT NULL | Total amount (principal + interest) payable |
| processingFees | DECIMAL(15,2) | NOT NULL | One-time processing fees charged |
| otherCharges | DECIMAL(15,2) | DEFAULT "0" | Additional fees and charges |
| agreementGenerated | BOOLEAN | NOT NULL, DEFAULT false | Whether agreement document generated |
| agreementUrl | VARCHAR(500) | - | URL to the generated agreement document |
| agreementSignedAt | TIMESTAMP | - | Timestamp when agreement was signed |
| agreementIp | VARCHAR(50) | - | IP address from which agreement was signed |
| sanctionedBy | UUID | FK, NOT NULL | User who approved the sanction |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT NOW | Record creation timestamp |
| updatedAt | TIMESTAMP | NOT NULL, DEFAULT NOW | Last update timestamp |

**Indexes:**
- `sanction_loan_app` on `loanApplicationId` - Fast lookup by loan application
- `sanction_letter` on `sanctionLetterNumber` - Fast lookup by sanction letter number
- `sanction_date` on `sanctionDate` - Date-based queries and reporting

**Relationships:**
- One-to-one with `loan_applications` via `loanApplicationId` (each loan application has exactly one sanction)
- Many-to-one with `users` via `sanctionedBy` (user who approved the sanction)

**Business Rules:**

1. **Sanction Lifecycle:**
   - Sanction can only be created for approved loan applications
   - Sanction automatically expires after `validUntil` timestamp
   - Once created, sanction cannot be modified (only new sanctions can be created)

2. **Letter Generation:**
   - `sanctionLetterNumber` must be unique across all sanctions
   - Letter number follows predefined format and is auto-generated
   - Letter is generated immediately upon sanction creation

3. **EMI Calculations:**
   - `totalInterestPayable` and `totalAmountPayable` are calculated based on sanctioned amount, interest rate, and tenure
   - EMI amount is calculated when sanction is approved
   - Calculations follow standard loan amortization formulas

4. **Agreement Workflow:**
   - Agreement is not generated by default (requires separate process)
   - Once agreement is generated, URL is stored in `agreementUrl`
   - Agreement signing timestamp and IP are tracked for audit purposes
   - Agreement must be signed before loan disbursement

5. **Fee Structure:**
   - `processingFees` is mandatory and must be greater than 0
   - `otherCharges` can be zero and has default value of 0
   - All fees are included in the total amount payable calculation

6. **Data Integrity:**
   - All monetary fields have precision 15,2 for accurate financial calculations
   - Timestamps use UTC format for consistency
   - UUID references ensure data integrity across tables
   - Unique constraint on loanApplicationId prevents multiple sanctions per application
