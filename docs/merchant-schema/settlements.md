# Settlements

## Tables

### settlements

Merchant payment settlements with financial breakdown and bank transfer details.

**Primary Key:** `id` (INTEGER/SERIAL)

**Foreign Keys:**
- `merchantId` → `merchants.id` (ON DELETE CASCADE)

**Columns:**
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | SERIAL | PK, NOT NULL | Unique settlement identifier |
| settlementNumber | VARCHAR(50) | UNIQUE, NOT NULL | Human-readable settlement number |
| merchantId | UUID | FK, NOT NULL | Reference to merchant |
| settlementPeriodStart | TIMESTAMP | NOT NULL | Settlement period start date |
| settlementPeriodEnd | TIMESTAMP | NOT NULL | Settlement period end date |
| totalOrders | INTEGER | NOT NULL, DEFAULT 0 | Total orders in period |
| ordersSettled | INTEGER | NOT NULL, DEFAULT 0 | Number of orders settled |
| totalSalesAmount | DECIMAL(15,2) | NOT NULL, DEFAULT 0.00 | Total sales before deductions |
| totalCommission | DECIMAL(15,2) | NOT NULL, DEFAULT 0.00 | Total commission deducted |
| totalRefunds | DECIMAL(15,2) | NOT NULL, DEFAULT 0.00 | Total refund amount |
| totalReturns | DECIMAL(15,2) | NOT NULL, DEFAULT 0.00 | Total return amount |
| totalCancellation | DECIMAL(15,2) | NOT NULL, DEFAULT 0.00 | Total cancellation amount |
| adjustments | DECIMAL(15,2) | NOT NULL, DEFAULT 0.00 | Manual adjustments |
| adjustmentNotes | TEXT | - | Notes explaining adjustments |
| netSettlementAmount | DECIMAL(15,2) | NOT NULL | Final amount to transfer |
| status | settlement_status ENUM | NOT NULL, DEFAULT 'pending' | Settlement status |
| bankAccountNumber | VARCHAR(35) | NOT NULL | Merchant bank account number |
| bankIfsc | VARCHAR(11) | NOT NULL | Bank IFSC code |
| bankAccountName | VARCHAR(255) | NOT NULL | Bank account holder name |
| initiatedAt | TIMESTAMP | - | Settlement initiation timestamp |
| processedAt | TIMESTAMP | - | Processing completion timestamp |
| completedAt | TIMESTAMP | - | Final completion timestamp |
| utr | VARCHAR(50) | - | UTR for NEFT/RTGS/IMPS |
| transactionReference | VARCHAR(255) | - | Bank transaction reference |
| paymentMethod | VARCHAR(50) | - | Payment method (neft/rtgs/imps/upi) |
| failureReason | TEXT | - | Reason for transfer failure |
| retryCount | INTEGER | DEFAULT 0 | Number of retry attempts |
| lastRetryAt | TIMESTAMP | - | Last retry timestamp |
| settlementReportUrl | VARCHAR(500) | - | URL to settlement report PDF |
| invoiceUrl | VARCHAR(500) | - | URL to settlement invoice |
| notes | TEXT | - | Additional notes |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT NOW | Settlement creation timestamp |
| updatedAt | TIMESTAMP | NOT NULL, DEFAULT NOW | Last update timestamp |

**Indexes:**
- `settlement_number` on `settlementNumber`
- `settlement_merchant` on `merchantId`
- `settlement_period` on `settlementPeriodStart`, `settlementPeriodEnd`
- `settlement_status` on `status`
- `settlement_utr` on `utr`
- `settlement_completed` on `completedAt`
- `settlement_created` on `createdAt`

**Business Rules:**
- Settlement uses 100% payout model (no reserve)
- `netSettlementAmount = totalSalesAmount - totalCommission - totalRefunds - totalReturns - totalCancellation + adjustments`
- Settlement periods are typically T+7 or T+15 from delivery date
  - T+7: Standard settlement (7 days after delivery)
  - T+15: Extended settlement (15 days after delivery)
- `settlementNumber` must be unique and human-readable (e.g., "STL-2024-001234")
- `status` values: `pending`, `processing`, `completed`, `failed`
- `paymentMethod` values: `neft`, `rtgs`, `imps`, `upi`
- Bank details (`bankAccountNumber`, `bankIfsc`, `bankAccountName`) are required for transfer
  - IFSC is Indian Financial System Code (11 characters)
  - Account number can be up to 35 characters for international banks
- `utr` (Unique Transaction Reference) is generated by bank for NEFT/RTGS/IMPS transfers
- Settlement lifecycle:
  1. `pending` - Orders gathered, awaiting processing
  2. `processing` - Transfer initiated
  3. `completed` - Transfer successful
  4. `failed` - Transfer failed, retry with `retryCount`
- `retryCount` tracks failed transfer attempts
- Settlements are automatically deleted when merchant is deleted (CASCADE)
- Settlement reports and invoices are stored as URLs (typically cloud storage)

---

### settlement_orders

Order-level settlement tracking with individual order financials and settlement dates.

**Primary Key:** `id` (INTEGER/SERIAL)

**Foreign Keys:**
- `settlementId` → `settlements.id` (ON DELETE CASCADE)
- `orderId` → `orders.id` (No DELETE action specified)

**Columns:**
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | SERIAL | PK, NOT NULL | Unique settlement order identifier |
| settlementId | INTEGER | FK, NOT NULL | Reference to parent settlement |
| orderId | INTEGER | FK, NOT NULL | Reference to order |
| orderAmount | DECIMAL(15,2) | NOT NULL | Original order amount |
| commissionAmount | DECIMAL(15,2) | NOT NULL | Commission deducted from order |
| refundAmount | DECIMAL(15,2) | DEFAULT 0.00 | Refund amount for this order |
| returnAmount | DECIMAL(15,2) | DEFAULT 0.00 | Return amount for this order |
| cancellationAmount | DECIMAL(15,2) | DEFAULT 0.00 | Cancellation amount for this order |
| netAmount | DECIMAL(15,2) | NOT NULL | Net settlement for this order |
| deliveredAt | TIMESTAMP | NOT NULL | Order delivery/completion timestamp |
| settlementDate | TIMESTAMP | NOT NULL | Expected settlement date |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT NOW | Settlement order creation timestamp |

**Indexes:**
- `settlement_order_settlement` on `settlementId`
- `settlement_order_order` on `orderId`
- `settlement_order_date` on `settlementDate`
- `settlement_order_delivered` on `deliveredAt`

**Business Rules:**
- Settlement orders are automatically deleted when parent settlement is deleted (CASCADE)
- Orders are included in settlement based on `deliveredAt` timestamp
  - T+7: `settlementDate = deliveredAt + 7 days`
  - T+15: `settlementDate = deliveredAt + 15 days`
- `netAmount = orderAmount - commissionAmount - refundAmount - returnAmount - cancellationAmount`
- One order belongs to exactly one settlement
- `deliveredAt` marks the completion of order fulfillment
  - For delivery: actual delivery timestamp
  - For pickup: pickup completion timestamp
  - For store purchase: purchase timestamp
- Settlements are typically created daily/weekly/monthly based on `settlementDate`
- All orders with `settlementDate` within the settlement period are grouped together
